name: Boards Addition Test

# The workflow will run on schedule and labeled pull requests
on:
  pull_request:
    types: [opened, reopened, synchronize, labeled]

env:
  # It's convenient to set variables for values used multiple times in the workflow
  GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}

jobs:
  compile-sketch:
    if: |
      contains(github.event.pull_request.labels.*.name, 'board_test')
    runs-on: ubuntu-latest

    env:
      REPOSITORY: |
        - source-path: '.'
          name: "espressif:esp32"

    # strategy:
    #   matrix:
    #     target:
        #   - esp32
        #   - esp32s2
        #   - esp32c3
        #   - esp32s3

        # include:
        #   - target: esp32
        #     fqbn: espressif:esp32:esp32
        #   - target: esp32s2
        #     fqbn: espressif:esp32:esp32s2
        #   - target: esp32c3
        #     fqbn: espressif:esp32:esp32c3
        #   - target: esp32s3
        #     fqbn: espressif:esp32:esp32s3

    steps:
      # This step makes the contents of the repository available to the workflow
      # - name: Checkout repository
      #   uses: actions/checkout@v3

      - name: Setup jq
        uses: dcarbone/install-jq-action@v1.0.1

      - name: Get board name
        run: 
          Patch=$(curl "https://api.github.com/repos/P-R-O-C-H-Y/arduino-esp32/pulls/${{github.event.number}}/files" | jq -r '.[] | select(.filename == "boards.txt") | .patch ')
          deletion_line=$( echo "$Patch" | cut -d'-' -f2 | cut -d',' -f1 )
          deletion_count=$( echo "$Patch" | cut -d',' -f2 | cut -d' ' -f1 )
          addition_line=$( echo "$Patch" | cut -d'+' -f2 | cut -d',' -f1 )
          addition_count=$( echo "$Patch" | cut -d'+' -f2 | cut -d',' -f2 | cut -d' ' -f1 )
          echo $deletion_line
          echo $deletion_count
          echo $addition_line
          echo $addition_count
          addition_end=$(($addition_line+$addition_count-$deletion_count))
          echo $addition_end
          echo "ADDITION_START=$(echo $addition_line)" >> $GITHUB_ENV
          echo "ADDITION_END=$(echo $addition_end)" >> $GITHUB_ENV

        # - name: Compile sketch
        #   uses: P-R-O-C-H-Y/compile-sketches@main
        #   with:
        #     platforms: |
        #       ${{ env.REPOSITORY }}
        #     target: ${{ matrix.target }}
        #     fqbn: ${{ matrix.fqbn }}
        #     use-json-file: false
        #     enable-deltas-report: false
        #     enable-warnings-report: false
        #     cli-compile-flags: |
        #       - --warnings="all"
        #     exit-on-fail: true
